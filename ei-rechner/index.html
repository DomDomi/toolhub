<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   <!-- SEO -->
  <title>Ei-Kochzeit Rechner: weich, wachsweich, hart ‚Äì mit Kurve & Timer</title>
  <meta name="description" content="Ei-Kochzeit Rechner f√ºr S/M/L/XL: weich bis hart. Ber√ºcksichtigt Starttemperatur & zeigt den Garverlauf als Kurve ‚Äì inkl. Live-Timer. Kostenlos & mobil." />
  <link rel="stylesheet" href="/assets/css/base.css">

  <!-- optional / vorhanden -->
  <link rel="canonical" href="https://toolhub-5ko.pages.dev/ei-rechner/" />
  <style>
    :root{
      --bg:#0b0f17; --card:#121a27; --text:#e9eef7; --muted:#9fb0c7; --accent:#4da3ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1120px;margin:0 auto;padding:18px}
    h1{font-size:1.5rem;margin:8px 0 4px}
    .sub{color:var(--muted);margin:0 0 14px;line-height:1.35}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:14px;align-items:start}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px}
    label{display:block;font-size:.92rem;margin:10px 0 6px;color:var(--muted)}
    input,select,button{font:inherit}
    input[type="number"], select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);color:var(--text)
    }
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(77,163,255,.12);border:1px solid rgba(77,163,255,.25);font-variant-numeric:tabular-nums}
    .kpi{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .kpi .pill{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)}
    .btns{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    button{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);color:var(--text);cursor:pointer
    }
    button.primary{border-color:rgba(77,163,255,.35);background:rgba(77,163,255,.16)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .big{font-size:1.15rem;font-weight:750;margin:6px 0 2px}
    .hint{color:var(--muted);margin:0;line-height:1.35}
    canvas{width:100%!important;height:440px!important}
    .small{font-size:.9rem;color:var(--muted);line-height:1.35;margin-top:10px}
    details{margin-top:10px}
    summary{cursor:pointer;color:var(--muted)}
    .mono{font-variant-numeric:tabular-nums}
  </style>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": "Wie lange muss ein Ei kochen, damit es weich oder hart ist?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Ein weiches Ei ist meist nach etwa 4‚Äì5 Minuten fertig, wachsweich nach 6‚Äì7 Minuten und ein hartes Ei nach etwa 9‚Äì11 Minuten. Gr√∂√üe, Starttemperatur und Kochmethode beeinflussen die Zeit."
        }
      },
      {
        "@type": "Question",
        "name": "Macht die Gr√∂√üe des Eis einen Unterschied bei der Kochzeit?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Ja. Gr√∂√üere Eier ben√∂tigen mehr Zeit als kleine Eier. Der Ei-Rechner ber√ºcksichtigt unterschiedliche Gr√∂√üen sowie Gewicht oder Durchmesser."
        }
      },
      {
        "@type": "Question",
        "name": "Soll man Eier kalt oder kochend ins Wasser legen?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Beides ist m√∂glich. Der Rechner unterst√ºtzt sowohl das Aufkochen in kaltem Wasser als auch das Einlegen in kochendes Wasser."
        }
      },
      {
        "@type": "Question",
        "name": "Beeinflusst die H√∂he √ºber dem Meeresspiegel die Kochzeit?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Ja. In h√∂heren Lagen kocht Wasser bei niedrigeren Temperaturen, wodurch Eier l√§nger brauchen. Der Rechner ber√ºcksichtigt diesen Effekt."
        }
      },
      {
        "@type": "Question",
        "name": "Wie genau ist der Ei-Rechner?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Der Rechner liefert eine praxisnahe N√§herung auf Basis von Modellen und Erfahrungswerten. F√ºr absolute Genauigkeit ist ein Thermometer erforderlich."
        }
      }
    ]
  }
  </script>

</head>

<body>
<div class="wrap">
  <h1>Ei-Rechner</h1>
  <p class="sub">
    Ei-Kochzeit Rechner mit Konsistenz-Kurve & Live-Timer
  </p>
  <h2>Was berechnet der Ei-Rechner?</h2>

  <p>
  Die Kochzeit eines Eis h√§ngt von mehreren Faktoren ab.
  Gr√∂√üe, Temperatur und gew√ºnschte Konsistenz beeinflussen,
  wie schnell Eiwei√ü und Eigelb fest werden.
  Dieser Rechner hilft dir, eine passende Kochzeit abzusch√§tzen
  und zeigt dir zus√§tzlich, wann welche Garstufe erreicht wird.
  </p>
  <h2>So benutzt du den Ei-Rechner</h2>

  <ol>
    <li>W√§hle die Gr√∂√üe deines Eis (z. B. M oder L).</li>
    <li>Gib an, ob das Ei aus dem K√ºhlschrank oder bei Zimmertemperatur ist.</li>
    <li>Starte die Stoppuhr, sobald das Wasser kocht.</li>
    <li>Beobachte im Diagramm, wann dein Ei weich, wachsweich oder hart wird.</li>
  </ol>
  <h2>Beispiele f√ºr Kochzeiten</h2>

  <ul>
    <li><b>Weiches Ei (Gr√∂√üe M):</b> ca. 4‚Äì5 Minuten ‚Äì Eiwei√ü fest, Eigelb fl√ºssig.</li>
    <li><b>Wachsweiches Ei (Gr√∂√üe M):</b> ca. 6‚Äì7 Minuten ‚Äì Kern noch cremig.</li>
    <li><b>Hartes Ei (Gr√∂√üe L):</b> ca. 9‚Äì10 Minuten ‚Äì Eigelb komplett fest.</li>
  </ul>

  <p>
  Die genauen Zeiten k√∂nnen leicht variieren.
  Der Rechner hilft dir, ein besseres Gef√ºhl f√ºr den richtigen Zeitpunkt zu bekommen.
  </p>
  <div class="grid">
    <!-- Inputs -->
    <div class="card">
      <label for="size">ü•ö Gr√∂√üe (Preset)</label>
      <select id="size">
        <option value="custom">Benutzerdefiniert</option>
        <option value="S">S (unter 53 g)</option>
        <option value="M" selected>M (53‚Äì63 g)</option>
        <option value="L">L (63‚Äì73 g)</option>
        <option value="XL">XL (ab 73 g)</option>
        <option value="XS">XS / Peewee (ca. 40‚Äì45 g)</option>
        <option value="XXL">XXL / Jumbo (ca. 80 g)</option>
      </select>

      <div class="row">
        <div>
          <label for="weight">‚öñÔ∏è Gewicht (g)</label>
          <input id="weight" type="number" min="30" max="120" step="0.1" value="58" />
        </div>
        <div>
          <label for="diameter">üìè Durchmesser (mm, optional)</label>
          <input id="diameter" type="number" min="35" max="70" step="0.1" placeholder="z. B. 44" />
        </div>
      </div>

      <label for="eggTempMode">üå°Ô∏è Ei-Temperatur</label>
      <div class="row">
        <select id="eggTempMode">
          <option value="fridge" selected>K√ºhlschrankkalt (~4¬∞C)</option>
          <option value="room">Zimmertemperatur (~20¬∞C)</option>
          <option value="warm">Frisch / warm (~35¬∞C)</option>
          <option value="custom">Benutzerdefiniert</option>
        </select>
        <div id="eggTempCustomWrap" style="display:none">
          <label for="eggTempCustom" style="margin-top:0">¬∞C</label>
          <input id="eggTempCustom" type="number" min="0" max="45" step="1" value="4" />
        </div>
      </div>

      <label for="altitude">‚õ∞Ô∏è H√∂he √ºber NN (m)</label>
      <input id="altitude" type="number" min="0" max="4000" step="10" value="0" />

      <label for="method">üç≤ Startmethode</label>
      <select id="method">
        <option value="boil" selected>In kochendes Wasser legen (Standard)</option>
        <option value="coldstart">Kaltstart: Ei ins Wasser, dann aufkochen</option>
      </select>

      <details>
        <summary>‚öôÔ∏è Konsistenz-Ziele (Basis: M-Ei) anpassen</summary>
        <div class="small">
          Defaults entsprechen deinem Beispiel f√ºr ein <b>M</b>-Ei:
          sehr weich 4:00 ‚Ä¢ weich 5:00 ‚Ä¢ wachsweich 6:30 ‚Ä¢ halbhart 8:30 ‚Ä¢ hart 10:30
        </div>
        <div class="row">
          <div><label>Sehr weich (min)</label><input id="t1" type="number" step="0.1" value="4.0"></div>
          <div><label>Weich (min)</label><input id="t2" type="number" step="0.1" value="5.0"></div>
        </div>
        <div class="row">
          <div><label>Wachsweich (min)</label><input id="t3" type="number" step="0.1" value="6.5"></div>
          <div><label>Halbhart (min)</label><input id="t4" type="number" step="0.1" value="8.5"></div>
        </div>
        <div><label>Hart (min)</label><input id="t5" type="number" step="0.1" value="10.5"></div>
      </details>

      <div class="btns">
        <button id="start" class="primary">‚ñ∂Ô∏è Start</button>
        <button id="pause" disabled>‚è∏Ô∏è Pause</button>
        <button id="reset">‚Ü©Ô∏è Reset</button>
      </div>

      <div class="kpi">
        <span class="pill">‚è±Ô∏è <b id="sw" class="mono">00:00.0</b></span>
        <span class="pill">üç≥ <b id="stageNow">‚Äî</b></span>
        <span class="pill">üå°Ô∏è Siedepunkt: <b id="boilPt" class="mono">100.0¬∞C</b></span>
      </div>

      
    </div>

    <!-- Chart -->
    <div class="card">
      <div class="big" id="headline">‚Äî</div>
      <p class="hint">
        <b>Soll-Kurve</b> = erwarteter Gargrad ‚Ä¢ <b>Live-Kurve</b> = bis zur aktuellen Stoppuhr-Zeit ‚Ä¢ Farbb√§nder = Konsistenz-Zonen
      </p>
      <canvas id="chart"></canvas>
      <div class="card" id="zoneInfoCard" style="margin-top:12px;">
        <div class="big" id="zoneTitle">Garbereich</div>
        <div class="hint" id="zoneText">Tippe im Diagramm auf einen farbigen Bereich, um Details zu sehen.</div>
        <div class="small" id="zoneRange"></div>
      </div>

      <p class="small">
        Tipp: Wenn du den Timer erst ab ‚ÄûWasser kocht‚Äú startest, stell die Startmethode auf ‚Äûkochendes Wasser‚Äú.
      </p>
    </div>
  </div>
  <!-- Share -->
  <div class="share-icons" aria-label="Tool teilen">
    <!-- WhatsApp -->
    <a class="share-icon wa"
      href="https://wa.me/?text=https://toolhub-5ko.pages.dev/ei-rechner/"
      target="_blank" rel="noopener"
      aria-label="Auf WhatsApp teilen">
      <!-- WhatsApp SVG -->
      <svg viewBox="0 0 32 32" aria-hidden="true">
        <path d="M19.11 17.21c-.27-.14-1.6-.79-1.85-.88-.25-.09-.43-.14-.61.14-.18.27-.7.88-.86 1.06-.16.18-.32.2-.59.07-.27-.14-1.15-.42-2.19-1.34-.81-.72-1.36-1.61-1.52-1.88-.16-.27-.02-.42.12-.56.12-.12.27-.32.41-.48.14-.16.18-.27.27-.45.09-.18.05-.34-.02-.48-.07-.14-.61-1.48-.84-2.03-.22-.53-.45-.46-.61-.46h-.52c-.18 0-.48.07-.73.34-.25.27-.96.93-.96 2.27 0 1.34.98 2.63 1.11 2.81.14.18 1.93 2.95 4.67 4.13.65.28 1.15.45 1.54.58.65.21 1.25.18 1.72.11.52-.08 1.6-.65 1.82-1.27.22-.62.22-1.16.16-1.27-.07-.11-.25-.18-.52-.32zM16 3C8.82 3 3 8.82 3 16c0 2.53.75 4.9 2.03 6.89L3 29l6.3-2.03A12.93 12.93 0 0 0 16 29c7.18 0 13-5.82 13-13S23.18 3 16 3z"/>
      </svg>
    </a>

    <!-- Telegram -->
    <a class="share-icon tg"
      href="https://t.me/share/url?url=https://toolhub-5ko.pages.dev/ei-rechner/"
      target="_blank" rel="noopener"
      aria-label="Auf Telegram teilen">
      <svg viewBox="0 0 32 32" aria-hidden="true">
        <path d="M29.91 6.13 24.9 26.2c-.38 1.42-1.38 1.77-2.8 1.1l-7.75-5.7-3.74 3.6c-.41.41-.76.76-1.55.76l.55-7.85L24 8.98c.6-.53-.13-.83-.93-.3L6.3 19.24l-7.25-2.26c-1.58-.49-1.61-1.58.33-2.34L27.7 3.6c1.33-.49 2.49.3 2.21 2.53z"/>
      </svg>
    </a>

    <!-- X / Twitter -->
    <a class="share-icon x"
      href="https://twitter.com/intent/tweet?url=https://toolhub-5ko.pages.dev/ei-rechner/"
      target="_blank" rel="noopener"
      aria-label="Auf X teilen">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M18.9 2H22l-6.8 7.8L23 22h-6.3l-4.9-6.4L6.1 22H3l7.3-8.4L1 2h6.5l4.4 5.8L18.9 2z"/>
      </svg>
    </a>

    <!-- E-Mail -->
    <a class="share-icon mail"
      href="mailto:?subject=Ei-Rechner&body=https://toolhub-5ko.pages.dev/ei-rechner/"
      aria-label="Per E-Mail teilen">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M2 4h20v16H2zM20 6l-8 5-8-5"/>
      </svg>
    </a>

    <!-- Copy -->
    <button class="share-icon copy" id="copyLink" aria-label="Link kopieren">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v16h13a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z"/>
      </svg>
    </button>
  </div>  
  <!-- FAQ -->
  <div class="faq" id="faq">
    <h2>H√§ufige Fragen zum Ei-Rechner</h2>

    <div class="faq-item">
      <h3 class="faq-q">Wie lange muss ein Ei kochen, damit es weich oder hart ist?</h3>
      <div class="faq-a">
        <p>
          Das h√§ngt von der gew√ºnschten Konsistenz ab. Ein weiches Ei ist meist nach etwa
          4‚Äì5 Minuten fertig, ein wachsweiches nach 6‚Äì7 Minuten und ein hartes Ei nach
          etwa 9‚Äì11 Minuten. Gr√∂√üe, Starttemperatur und Kochmethode spielen dabei eine
          wichtige Rolle.
        </p>
      </div>
    </div>

    <div class="faq-item">
      <h3 class="faq-q">Macht die Gr√∂√üe des Eis einen Unterschied bei der Kochzeit?</h3>
      <div class="faq-a">
        <p>
          Ja. Gr√∂√üere Eier (z. B. L oder XL) ben√∂tigen mehr Zeit als kleine Eier.
          Der Ei-Rechner ber√ºcksichtigt unterschiedliche Gr√∂√üen und kann auch mit
          Gewicht oder Durchmesser arbeiten.
        </p>
      </div>
    </div>

    <div class="faq-item">
      <h3 class="faq-q">Soll man Eier kalt oder kochend ins Wasser legen?</h3>
      <div class="faq-a">
        <p>
          Beides ist m√∂glich. Viele legen Eier in kaltes Wasser und bringen es dann zum
          Kochen, andere geben sie direkt in kochendes Wasser. Der Rechner ber√ºcksichtigt
          beide Varianten sowie die Starttemperatur des Eis.
        </p>
      </div>
    </div>

    <div class="faq-item">
      <h3 class="faq-q">Beeinflusst die H√∂he √ºber dem Meeresspiegel die Kochzeit?</h3>
      <div class="faq-a">
        <p>
          Ja. In h√∂heren Lagen sinkt der Siedepunkt von Wasser, wodurch Eier l√§nger
          brauchen. Der Ei-Rechner passt die Zeiten entsprechend an, wenn du die H√∂he
          angibst.
        </p>
      </div>
    </div>

    <div class="faq-item">
      <h3 class="faq-q">Warum ist mein Ei trotz gleicher Zeit manchmal anders?</h3>
      <div class="faq-a">
        <p>
          Kleine Unterschiede entstehen durch Eiergr√∂√üe, Alter des Eis, Starttemperatur,
          Topfgr√∂√üe, Wassermenge und Hitzequelle. Der Rechner liefert eine realistische
          N√§herung, kann diese Faktoren aber nicht vollst√§ndig eliminieren.
        </p>
      </div>
    </div>

    <div class="faq-item">
      <h3 class="faq-q">Wie genau ist der Ei-Rechner?</h3>
      <div class="faq-a">
        <p>
          Der Rechner basiert auf physikalischen Modellen und Erfahrungswerten und ist f√ºr
          den Alltag sehr zuverl√§ssig. Er ersetzt jedoch kein K√ºchenthermometer, wenn
          absolute Genauigkeit erforderlich ist.
        </p>
      </div>
    </div>
  </div>
  <!-- Weitere Rechner -->
  <div class="moreCalc">
    <div class="big" id="headline">‚Äî</div>
    <h2>Weitere hilfreiche Rechner</h2>

    <ul>
      <li><a href="/steakandbread-timer/">Steak & Brot Timer ‚Äì Kerntemperaturen</a></li>
      <li><a href="/mischverhaeltnis/">Mischverh√§ltnis-Rechner</a></li>
      <li><a href="/abokosten-rechner/">Was kostet mich ein Abo wirklich?</a></li>
    </ul>
  </div> 


   
  
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
document.getElementById('copyLink')?.addEventListener('click', () => {
  navigator.clipboard.writeText(location.href);
});
</script>

<script>
  // ---------------------------
  // Presets
  // ---------------------------
  const SIZE_TO_WEIGHT = { XS:44, S:50, M:58, L:68, XL:75, XXL:80 };

  // Baseline: M (58g), 4¬∞C, 0m, "boil"
  const M0 = 58;
  const D0 = 44;
  const BASE_BOIL_C = 100;

  function n(x, fallback=0){
    const v = Number(x);
    return Number.isFinite(v) ? v : fallback;
  }

  // Ei-Temp -> Faktor (einfach, brauchbar)
  function eggTempFactor(tempC){
    const t = Math.max(0, Math.min(45, tempC));
    if (t <= 4) return 1.00;
    if (t <= 20){
      const a = (t - 4) / (20 - 4);
      return 1.00 + a * (0.78 - 1.00);
    }
    if (t <= 35){
      const a = (t - 20) / (35 - 20);
      return 0.78 + a * (0.70 - 0.78);
    }
    const a = (t - 35) / (45 - 35);
    return 0.70 + a * (0.66 - 0.70);
  }

  function massFactor(m){ return Math.pow(m / M0, 2/3); }
  function diameterFactor(dmm){
    if (!Number.isFinite(dmm) || dmm <= 0) return 1.0;
    return Math.pow(dmm / D0, 2);
  }

  // H√∂he -> Siedepunkt (grob): ~1¬∞C pro 285 m
  function boilingPointC(altM){
    const a = Math.max(0, altM);
    return Math.max(80, BASE_BOIL_C - (a / 285));
  }

  // Zeitfaktor pro ¬∞C unter 100: +3%/¬∞C
  function altitudeCookFactor(altM){
    const bp = boilingPointC(altM);
    const delta = BASE_BOIL_C - bp;
    return 1 + delta * 0.03;
  }

  // Kaltstart extra (vereinfachtes Modell)
  function coldStartExtraMinutes(altM){
    const bp = boilingPointC(altM);
    const deltaToHeat = bp - 20;
    return Math.max(1.5, 3.0 * (deltaToHeat / 80));
  }

  // Map Gargrad% -> Stage label
  function stageFromPercent(p){
    if (p < 20) return "Noch nicht (zu roh)";
    if (p < 40) return "Sehr weich";
    if (p < 60) return "Weich / Fr√ºhst√ºcksei";
    if (p < 80) return "Wachsweich / Kernweich";
    if (p < 100) return "Fest / Halbhart";
    return "Hart";
  }

  const STAGE_INFO = [
    {
      key: "Sehr weich",
      title: "Sehr weich",
      text: "Eiwei√ü ist fest, Eigelb komplett fl√ºssig."
    },
    {
      key: "Weich / Fr√ºhst√ºcksei",
      title: "Weich / Fr√ºhst√ºcksei",
      text: "Eiklar fest, Eigelb fl√ºssig-cremig."
    },
    {
      key: "Wachsweich / Kernweich",
      title: "Wachsweich / Kernweich",
      text: "Eigelb am Rand fest, in der Mitte noch fl√ºssig/z√§hfl√ºssig."
    },
    {
      key: "Fest / Halbhart",
      title: "Fest / Halbhart",
      text: "Eigelb weitgehend gestockt, aber noch nicht trocken."
    },
    {
      key: "Hart",
      title: "Hart",
      text: "Eigelb komplett fest und schnittfest."
    }
  ];

  function stageIndexFromTime(min, thresholds){
    const [t1,t2,t3,t4,t5] = thresholds;

    // Vor "sehr weich": wir zeigen keinen Garbereich (optional)
    if (min < t1) return -1;

    if (min < t2) return 0; // sehr weich
    if (min < t3) return 1; // weich
    if (min < t4) return 2; // wachsweich
    if (min < t5) return 3; // halbhart
    return 4;               // hart
  }

  function fmtRange(a,b){
    if (!Number.isFinite(b)) return `${formatMin(a)} ‚Äì ‚àû`;
    return `${formatMin(a)} ‚Äì ${formatMin(b)}`;
  }


  // ---------------------------
  // UI
  // ---------------------------
  const elSize = document.getElementById('size');
  const elWeight = document.getElementById('weight');
  const elDiameter = document.getElementById('diameter');
  const elEggTempMode = document.getElementById('eggTempMode');
  const elEggTempCustomWrap = document.getElementById('eggTempCustomWrap');
  const elEggTempCustom = document.getElementById('eggTempCustom');
  const elAltitude = document.getElementById('altitude');
  const elMethod = document.getElementById('method');

  const elT1 = document.getElementById('t1');
  const elT2 = document.getElementById('t2');
  const elT3 = document.getElementById('t3');
  const elT4 = document.getElementById('t4');
  const elT5 = document.getElementById('t5');

  const elHeadline = document.getElementById('headline');
  const elStageNow = document.getElementById('stageNow');
  const elBoilPt = document.getElementById('boilPt');

  const btnStart = document.getElementById('start');
  const btnPause = document.getElementById('pause');
  const btnReset = document.getElementById('reset');
  const elSw = document.getElementById('sw');

  function getEggTempC(){
    const mode = elEggTempMode.value;
    if (mode === "fridge") return 4;
    if (mode === "room") return 20;
    if (mode === "warm") return 35;
    return n(elEggTempCustom.value, 4);
  }

  function getBaseTimesMinutes(){
    const t1 = Math.max(0, n(elT1.value, 4.0));
    const t2 = Math.max(t1, n(elT2.value, 5.0));
    const t3 = Math.max(t2, n(elT3.value, 6.5));
    const t4 = Math.max(t3, n(elT4.value, 8.5));
    const t5 = Math.max(t4, n(elT5.value, 10.5));
    return [t1,t2,t3,t4,t5];
  }

  function computeThresholds(){
    const size = elSize.value;
    let weight = n(elWeight.value, 58);
    if (size !== "custom" && SIZE_TO_WEIGHT[size]) weight = SIZE_TO_WEIGHT[size];
    elWeight.value = weight;

    const diameterMm = elDiameter.value.trim() === "" ? NaN : n(elDiameter.value, NaN);
    const eggTempC = getEggTempC();
    const altM = Math.max(0, n(elAltitude.value, 0));
    const method = elMethod.value;

    const base = getBaseTimesMinutes();

    const factor =
      massFactor(weight) *
      diameterFactor(diameterMm) *
      eggTempFactor(eggTempC) *
      altitudeCookFactor(altM);

    let thresholds = base.map(t => t * factor);

    if (method === "coldstart"){
      const extra = coldStartExtraMinutes(altM);
      thresholds = thresholds.map(t => t + extra);
    }

    const bp = boilingPointC(altM);
    elBoilPt.textContent = bp.toFixed(1) + "¬∞C";

    return { thresholds, weight, diameterMm, eggTempC, altM, method, bp };
  }

  // Gargrad% linear zwischen den Schwellen
  function gargradAtTime(min, thresholds){
    const [t1,t2,t3,t4,t5] = thresholds;
    const pts = [
      {t:0,  p:0},
      {t:t1, p:20},
      {t:t2, p:40},
      {t:t3, p:60},
      {t:t4, p:80},
      {t:t5, p:100},
    ];
    if (min <= 0) return 0;
    if (min >= t5) return 100;

    for (let i=0; i<pts.length-1; i++){
      const a = pts[i], b = pts[i+1];
      if (min >= a.t && min <= b.t){
        const span = (b.t - a.t) || 1e-9;
        const x = (min - a.t) / span;
        return a.p + x * (b.p - a.p);
      }
    }
    return 0;
  }

  function buildCurveData(maxMin, thresholds, stepSec=5){
    const data = [];
    const stepMin = stepSec / 60;
    for (let t=0; t<=maxMin + 1e-9; t += stepMin){
      const p = gargradAtTime(t, thresholds);
      data.push({x: Number(t.toFixed(4)), y: Math.min(110, Math.max(0, p))});
    }
    return data;
  }

  function formatMin(min){
    const totalSec = Math.max(0, min * 60);
    const m = Math.floor(totalSec / 60);
    const s = Math.floor(totalSec % 60);
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  function stageFromTime(min, thresholds){
  const [t1,t2,t3,t4,t5] = thresholds;
  if (min < t1) return { name: "Noch nicht (zu roh)", from: 0, to: t1 };
  if (min < t2) return { name: "Sehr weich", from: t1, to: t2 };
  if (min < t3) return { name: "Weich / Fr√ºhst√ºcksei", from: t2, to: t3 };
  if (min < t4) return { name: "Wachsweich / Kernweich", from: t3, to: t4 };
  if (min < t5) return { name: "Fest / Halbhart", from: t4, to: t5 };
  return { name: "Hart", from: t5, to: Infinity };
}

function fmtRange(a, b){
  if (!Number.isFinite(b)) return `${formatMin(a)} ‚Äì ‚àû`;
  return `${formatMin(a)} ‚Äì ${formatMin(b)}`;
}


  // ---------------------------
  // Stable plugin: stage regions (no dynamic bind)
  // Regions: [t1..t2], [t2..t3], [t3..t4], [t4..t5], [t5..xMax]
  // ---------------------------
  const stageRegionsPlugin = {
    id: 'stageRegions',
    beforeDatasetsDraw(chart){
      const { ctx, chartArea, scales } = chart;
      if (!chartArea) return;

      const thresholds = chart.options?.plugins?.stageRegions?.thresholds;
      if (!thresholds) return;

      const x = scales.x;
      const [t1,t2,t3,t4,t5] = thresholds;
      const edges = [t1,t2,t3,t4,t5, x.max];

      const colors = [
        "rgba(77,163,255,0.14)",
        "rgba(77,163,255,0.18)",
        "rgba(77,163,255,0.22)",
        "rgba(77,163,255,0.26)",
        "rgba(77,163,255,0.30)",
      ];

      ctx.save();
      for (let i=0; i<5; i++){
        const left = x.getPixelForValue(edges[i]);
        const right = x.getPixelForValue(edges[i+1]);
        ctx.fillStyle = colors[i];
        ctx.fillRect(left, chartArea.top, right-left, chartArea.bottom - chartArea.top);

        const activeIndex = chart.options?.plugins?.stageRegions?.activeIndex;
        if (Number.isInteger(activeIndex) && activeIndex >= 0 && i === activeIndex) {
          ctx.save();

          // kr√§ftiges Pink, passend zum Live-Punkt
          ctx.strokeStyle = "rgba(255, 92, 122, 0.95)";
          ctx.lineWidth = 2;

          //Mobil Besser sichtbar
          ctx.shadowColor = "rgba(255,92,122,0.6)";
          ctx.shadowBlur = 6;

          // Rahmen minimal insetten, damit er nicht "klebt"
          ctx.strokeRect(
            left + 1,
            chartArea.top + 1,
            (right - left) - 2,
            (chartArea.bottom - chartArea.top) - 2
          );

          ctx.restore();
        }

      }
      ctx.restore();
    }
  };

  // ---------------------------
  // Chart
  // ---------------------------
  const chart = new Chart(document.getElementById('chart'), {
    type:'line',
    data:{
      datasets:[
        {
          label:"Soll-Kurve (Gargrad)",
          data:[],
          parsing:false,
          borderWidth:2,
          pointRadius:0,
          tension:0.25,
          borderColor:"rgba(77,163,255,0.95)"
        },
        {
          label:"Live-Kurve (Stoppuhr)",
          data:[],
          parsing:false,
          borderWidth:2,
          pointRadius:0,
          tension:0.25,
          borderColor:"rgba(255,92,122,0.95)"
        },
        {
          label:"Live-Punkt",
          data:[],
          parsing:false,
          showLine:false,
          borderWidth:0,
          pointRadius:4,
          pointBackgroundColor:"rgba(255,92,122,0.95)"
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:false, // important for mobile stability & speed
      plugins:{
        legend:{ display:true, labels:{ color:"rgba(233,238,247,.9)" } },
        tooltip:{
          callbacks:{
            title:(items)=>{
              const xVal = items?.[0]?.parsed?.x ?? 0;
              return `Zeit: ${formatMin(xVal)}`;
            },
            label:(item)=>{
              const y = item.parsed.y;
              return `${item.dataset.label}: ${Math.round(y)}% ‚Ä¢ ${stageFromPercent(y)}`;
            },
            afterBody:(items)=>{
              const xVal = items?.[0]?.parsed?.x ?? 0;
              const thresholds = chart.options?.plugins?.stageRegions?.thresholds;
              if (!thresholds) return [];
              const s = stageFromTime(xVal, thresholds);
              return [
                `Zone: ${s.name}`,
                `Bereich: ${fmtRange(s.from, s.to)}`
              ];
            }
          }
        },
        stageRegions: { thresholds: null }
      },
      scales:{
        x:{
          type:'linear',
          title:{ display:true, text:'Zeit', color:"rgba(233,238,247,.9)" },
          ticks:{ color:"rgba(159,176,199,.9)", callback:(v)=>formatMin(v) },
          grid:{ color:"rgba(255,255,255,.06)" },
          min:0,
          max:12
        },
        y:{
          title:{ display:true, text:'Gargrad', color:"rgba(233,238,247,.9)" },
          ticks:{ color:"rgba(159,176,199,.9)", callback:(v)=>`${v}%` },
          grid:{ color:"rgba(255,255,255,.06)" },
          min:0,
          max:100
        }
      }
    },
    plugins:[stageRegionsPlugin]
  });


  const zoneTitle = document.getElementById("zoneTitle");
  const zoneText  = document.getElementById("zoneText");
  const zoneRange = document.getElementById("zoneRange");

  chart.canvas.addEventListener("click", (evt) => {
    const thresholds = chart.options?.plugins?.stageRegions?.thresholds;
    if (!thresholds) return;

    // X-Position -> Zeit (Minuten) auslesen
    const rect = chart.canvas.getBoundingClientRect();
    const xPixel = evt.clientX - rect.left;
    const xScale = chart.scales.x;

    const tMin = xScale.getValueForPixel(xPixel);

    // Welche Zone?
    const idx = stageIndexFromTime(tMin, thresholds);

    if (idx < 0) {
      zoneTitle.textContent = "Noch nicht";
      zoneText.textContent = "Dieser Bereich liegt vor der ersten Garstufe (noch nicht 'sehr weich').";
      zoneRange.textContent = `Zeit: 00:00 ‚Äì ${formatMin(thresholds[0])}`;
      return;
    }

    const info = STAGE_INFO[idx];
    const edges = [thresholds[0],thresholds[1],thresholds[2],thresholds[3],thresholds[4], Infinity];
    const from = idx === 0 ? thresholds[0] : edges[idx];
    const to   = edges[idx+1];

    zoneTitle.textContent = info.title;
    zoneText.textContent  = info.text;
    zoneRange.textContent = `Bereich: ${fmtRange(from, to)} (geklickt bei ${formatMin(tMin)})`;
  });


  // Build + update datasets without forcing chart.update inside
  function setChartData(stopwatchMin){
    const { thresholds, weight, diameterMm, eggTempC, altM, method, bp } = computeThresholds();
    const [t1,t2,t3,t4,t5] = thresholds;

    const maxX = Math.max(12, t5 * 1.18);
    chart.options.scales.x.max = maxX;
    chart.options.plugins.stageRegions.thresholds = thresholds; // for plugin
    chart.options.plugins.stageRegions.activeIndex =
    Number.isFinite(stopwatchMin)
      ? stageIndexFromTime(stopwatchMin, thresholds)
      : null;

    const diaTxt = Number.isFinite(diameterMm) ? `, √ò ${diameterMm.toFixed(1)} mm` : "";
    const methodTxt = method === "coldstart" ? "Kaltstart" : "kochendes Wasser";
    elHeadline.textContent =
      `Ei ${weight.toFixed(1)} g${diaTxt} ‚Ä¢ Ei-Temp ${eggTempC}¬∞C ‚Ä¢ H√∂he ${altM} m ‚Ä¢ ${methodTxt} ‚Ä¢ Siedepunkt ${bp.toFixed(1)}¬∞C`;

    const soll = buildCurveData(maxX, thresholds, 5);
    chart.data.datasets[0].data = soll;

    if (Number.isFinite(stopwatchMin)) {
      const live = [];
      for (const pt of soll){
        if (pt.x <= stopwatchMin) live.push(pt);
        else break;
      }
      const liveY = gargradAtTime(stopwatchMin, thresholds);
      const p = Math.min(110, Math.max(0, liveY));

      chart.data.datasets[1].data = live;
      chart.data.datasets[2].data = [{ x: stopwatchMin, y: p }];
      elStageNow.textContent = stageFromPercent(p);
    } else {
      chart.data.datasets[1].data = [];
      chart.data.datasets[2].data = [];
      elStageNow.textContent = "‚Äî";
    }
  }

  // ---------------------------
  // Stopwatch with throttled chart updates (mobile fix)
  // ---------------------------
  let running = false;
  let startTs = 0;
  let elapsedMs = 0;
  let rafId = null;

  // Chart update throttle
  let lastChartUpdate = 0;
  const CHART_FPS = 10; // stable on mobile

  function renderStopwatch(){
    const ms = elapsedMs + (running ? (performance.now() - startTs) : 0);
    const totalSec = ms / 1000;

    // UI timer (can be "fast")
    const m = Math.floor(totalSec / 60);
    const s = Math.floor(totalSec % 60);
    const tenths = Math.floor((totalSec - Math.floor(totalSec)) * 10);
    elSw.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${tenths}`;

    // Chart only at CHART_FPS
    const now = performance.now();
    if (now - lastChartUpdate >= (1000 / CHART_FPS)) {
      lastChartUpdate = now;
      setChartData(totalSec / 60);
      chart.update('none'); // no animation
    }

    rafId = requestAnimationFrame(renderStopwatch);
  }

  function start(){
    if (running) return;
    running = true;
    startTs = performance.now();
    btnStart.disabled = true;
    btnPause.disabled = false;
    // immediate first update
    lastChartUpdate = 0;
    rafId = requestAnimationFrame(renderStopwatch);
  }

  function pause(){
    if (!running) return;
    running = false;
    elapsedMs += performance.now() - startTs;
    btnStart.disabled = false;
    btnPause.disabled = true;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    // final update at paused time
    const min = (elapsedMs/1000)/60;
    setChartData(min);
    chart.update('none');
  }

  function reset(){
    running = false;
    elapsedMs = 0;
    btnStart.disabled = false;
    btnPause.disabled = true;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    elSw.textContent = "00:00.0";

    setChartData(null);
    chart.update('none');
  }

  btnStart.addEventListener('click', start);
  btnPause.addEventListener('click', pause);
  btnReset.addEventListener('click', reset);

  // ---------------------------
  // Input updates (only re-render chart when not running)
  // ---------------------------
  function onInputsChanged(){
    if (running) return; // avoid fighting with live updates
    setChartData(null);
    chart.update('none');
  }

  elEggTempMode.addEventListener('change', ()=>{
    elEggTempCustomWrap.style.display = (elEggTempMode.value === "custom") ? "block" : "none";
    onInputsChanged();
  });

  elSize.addEventListener('change', ()=>{
    const v = elSize.value;
    if (v !== "custom" && SIZE_TO_WEIGHT[v]) elWeight.value = SIZE_TO_WEIGHT[v];
    onInputsChanged();
  });

  [elWeight, elDiameter, elAltitude, elMethod, elEggTempCustom, elT1, elT2, elT3, elT4, elT5].forEach(el=>{
    el.addEventListener('input', onInputsChanged);
    el.addEventListener('change', onInputsChanged);
  });

  // init
  elEggTempCustomWrap.style.display = "none";
  setChartData(null);
  chart.update('none');
</script>


</body>
</html>
