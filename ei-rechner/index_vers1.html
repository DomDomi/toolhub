<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ei-Rechner (mit Konsistenz-Kurve + Stoppuhr)</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a27; --text:#e9eef7; --muted:#9fb0c7; --accent:#4da3ff;
      --ok:#39d98a; --warn:#ffd166; --hot:#ff5c7a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{font-size:1.5rem;margin:8px 0 4px}
    .sub{color:var(--muted);margin:0 0 14px;line-height:1.35}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:14px;align-items:start}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr;} }
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px}
    label{display:block;font-size:.92rem;margin:10px 0 6px;color:var(--muted)}
    input,select,button{font:inherit}
    input[type="number"], select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);color:var(--text)
    }
    input[type="range"]{width:100%}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(77,163,255,.12);border:1px solid rgba(77,163,255,.25);font-variant-numeric:tabular-nums}
    .kpi{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .kpi .pill{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)}
    .btns{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    button{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);color:var(--text);cursor:pointer
    }
    button.primary{border-color:rgba(77,163,255,.35);background:rgba(77,163,255,.16)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .big{font-size:1.25rem;font-weight:750;margin:6px 0 2px}
    .hint{color:var(--muted);margin:0;line-height:1.35}
    canvas{width:100%!important;height:420px!important}
    .small{font-size:.9rem;color:var(--muted);line-height:1.35;margin-top:10px}
    details{margin-top:10px}
    summary{cursor:pointer;color:var(--muted)}
    .stageBadge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06)}
  </style>
</head>

<body>
<div class="wrap">
  <h1>Ei-Rechner: Konsistenz-Kurve + Live-Stoppuhr</h1>
  <p class="sub">
    W√§hle eine Gr√∂√üe (S/M/L/XL etc.) oder gib <b>Gewicht</b> und optional <b>Durchmesser</b> an.
    Das Diagramm zeigt, wann dein Ei welche Konsistenz erreicht ‚Äì plus eine Live-Linie, wenn die Stoppuhr l√§uft.
  </p>

  <div class="grid">
    <!-- Inputs -->
    <div class="card">
      <label for="size">ü•ö Gr√∂√üe (Preset)</label>
      <select id="size">
        <option value="custom">Benutzerdefiniert</option>
        <option value="S">S (unter 53 g)</option>
        <option value="M" selected>M (53‚Äì63 g)</option>
        <option value="L">L (63‚Äì73 g)</option>
        <option value="XL">XL (ab 73 g)</option>
        <option value="XS">XS / Peewee (ca. 40‚Äì45 g)</option>
        <option value="XXL">XXL / Jumbo (ca. 80 g)</option>
      </select>

      <div class="row">
        <div>
          <label for="weight">‚öñÔ∏è Gewicht (g)</label>
          <input id="weight" type="number" min="30" max="120" step="0.1" value="58" />
        </div>
        <div>
          <label for="diameter">üìè Durchmesser (mm, optional)</label>
          <input id="diameter" type="number" min="35" max="70" step="0.1" placeholder="z. B. 44" />
        </div>
      </div>

      <label for="eggTemp">üå°Ô∏è Starttemperatur Ei (¬∞C)</label>
      <div class="row" style="align-items:center">
        <input id="eggTemp" type="range" min="4" max="21" step="1" value="4" />
        <span class="pill"><span id="eggTempVal">4</span>¬∞C</span>
      </div>

      <label for="method">üç≤ Methode</label>
      <select id="method">
        <option value="boil" selected>In kochendes Wasser legen (Standard)</option>
        <option value="coldstart">In kaltem Wasser starten & aufkochen (langsamer, ungenauer)</option>
      </select>

      <details>
        <summary>‚öôÔ∏è Konsistenzen anpassen (optional)</summary>
        <div class="small">
          Standard basiert auf deinem Beispiel f√ºr ein <b>M</b>-Ei:
          sehr weich 4:00 ‚Ä¢ weich 5:00 ‚Ä¢ wachsweich 6:30 ‚Ä¢ halbhart 8:30 ‚Ä¢ hart 10:30
        </div>
        <div class="row">
          <div><label>Sehr weich (min)</label><input id="t1" type="number" step="0.1" value="4.0"></div>
          <div><label>Weich (min)</label><input id="t2" type="number" step="0.1" value="5.0"></div>
        </div>
        <div class="row">
          <div><label>Wachsweich (min)</label><input id="t3" type="number" step="0.1" value="6.5"></div>
          <div><label>Halbhart (min)</label><input id="t4" type="number" step="0.1" value="8.5"></div>
        </div>
        <div><label>Hart (min)</label><input id="t5" type="number" step="0.1" value="10.5"></div>
      </details>

      <div class="btns">
        <button id="start" class="primary">‚ñ∂Ô∏è Start</button>
        <button id="pause" disabled>‚è∏Ô∏è Pause</button>
        <button id="reset">‚Ü©Ô∏è Reset</button>
      </div>

      <div class="kpi">
        <span class="pill">‚è±Ô∏è Stoppuhr: <b id="sw">00:00.0</b></span>
        <span class="pill">üç≥ Aktuell: <b id="stageNow">‚Äî</b></span>
      </div>

      <p class="small">
        Hinweis: Das ist ein <b>Modell</b> (Praxis h√§ngt u.a. von Topf, Wassermenge, H√∂he √ºber NN, Ei-Form ab).
        Es ist aber sehr brauchbar ‚Äì und vor allem: <b>visuell</b>.
      </p>
    </div>

    <!-- Chart -->
    <div class="card">
      <div class="big" id="headline">F√ºr dein Ei (58 g): Zeitfenster je Konsistenz</div>
      <p class="hint" id="detail">
        Bewege die Regler ‚Äì das Diagramm aktualisiert live. Wenn die Stoppuhr l√§uft, siehst du eine vertikale Live-Linie.
      </p>
      <canvas id="chart"></canvas>
      <p class="small">
        Grafik: Farbfl√§chen = Konsistenz-Bereiche ‚Ä¢ Vertikale Linie = aktuelle Stoppuhr-Zeit
      </p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // ---------------------------
  // 1) Presets (Gewicht) ‚Äì EU-√§hnliche Bereiche + 2 Extras
  // ---------------------------
  const SIZE_TO_WEIGHT = {
    XS: 44,     // grob
    S: 50,      // unter 53g -> repr√§sentativ
    M: 58,      // 53‚Äì63g -> repr√§sentativ
    L: 68,      // 63‚Äì73g -> repr√§sentativ
    XL: 75,     // >=73g -> repr√§sentativ
    XXL: 80     // grob
  };

  // ---------------------------
  // 2) Zeit-Skalierung (einfach, aber sinnvoll)
  //    - Baseline: deine M-Zeiten gelten f√ºr ~58g Ei aus dem K√ºhlschrank (4¬∞C)
  //    - Masse-Skalierung ~ (m/m0)^(2/3) (W√§rmeleitung in K√∂rpern ~ L^2, L ~ m^(1/3))
  //    - Temperaturfaktor: k√ºhleres Ei braucht l√§nger (linear zwischen 4¬∞C und 21¬∞C)
  //    - optional Durchmesser (mm): wenn angegeben, skaliere zus√§tzlich ~ (d/d0)^2
  //      (weil Zeit ~ L^2 bei Diffusion) ‚Äì d0 ~ 44mm als typischer M-Durchmesser
  // ---------------------------
  const M0 = 58;     // g
  const D0 = 44;     // mm (typisch)
  const T_FRIDGE = 4;
  const T_ROOM = 21;
  // Aus Exeter-Beispiel: gleiches Ei braucht ca. 4.5 min (4¬∞C) vs 3.5 min (21¬∞C) => Faktor ~0.78 bei Raumtemp
  const ROOM_FACTOR = 0.78;

  function massFactor(m) {
    return Math.pow(m / M0, 2/3);
  }
  function tempFactor(tEggC) {
    // linearer √úbergang von 1.0 (4¬∞C) zu 0.78 (21¬∞C)
    const t = Math.min(T_ROOM, Math.max(T_FRIDGE, tEggC));
    const alpha = (t - T_FRIDGE) / (T_ROOM - T_FRIDGE);
    return 1.0 + alpha * (ROOM_FACTOR - 1.0);
  }
  function diameterFactor(dmm) {
    if (!Number.isFinite(dmm) || dmm <= 0) return 1.0;
    return Math.pow(dmm / D0, 2);
  }
  function methodFactor(method) {
    // Cold-start ist oft langsamer/variabler -> pauschal +12%
    return method === "coldstart" ? 1.12 : 1.0;
  }

  function scaleTimes(baseMinutesArray, {weightG, eggTempC, diameterMm, method}) {
    const mF = massFactor(weightG);
    const tF = tempFactor(eggTempC);
    const dF = diameterFactor(diameterMm);
    const methF = methodFactor(method);
    const factor = mF * tF * dF * methF;
    return baseMinutesArray.map(x => x * factor);
  }

  // ---------------------------
  // 3) Konsistenz-Definition (deine Texte)
  // ---------------------------
  const STAGES = [
    { key: "verysoft", label: "Sehr weich", desc: "Eiwei√ü fest, Eigelb komplett fl√ºssig" },
    { key: "soft",     label: "Weich / Fr√ºhst√ºcksei", desc: "Eiklar fest, Eigelb fl√ºssig-cremig" },
    { key: "waxy",     label: "Wachsweich / Kernweich", desc: "Eigelb am Rand fest, Mitte fl√ºssig/z√§h" },
    { key: "medium",   label: "Fest / Halbhart", desc: "Eigelb weitgehend gestockt, nicht trocken" },
    { key: "hard",     label: "Hart", desc: "Eigelb komplett fest und schnittfest" },
  ];

  // ---------------------------
  // 4) UI elements
  // ---------------------------
  const elSize = document.getElementById('size');
  const elWeight = document.getElementById('weight');
  const elDiameter = document.getElementById('diameter');
  const elEggTemp = document.getElementById('eggTemp');
  const elEggTempVal = document.getElementById('eggTempVal');
  const elMethod = document.getElementById('method');

  const elT1 = document.getElementById('t1');
  const elT2 = document.getElementById('t2');
  const elT3 = document.getElementById('t3');
  const elT4 = document.getElementById('t4');
  const elT5 = document.getElementById('t5');

  const elHeadline = document.getElementById('headline');
  const elStageNow = document.getElementById('stageNow');

  const btnStart = document.getElementById('start');
  const btnPause = document.getElementById('pause');
  const btnReset = document.getElementById('reset');
  const elSw = document.getElementById('sw');

  function n(x, fallback=0){
    const v = Number(x);
    return Number.isFinite(v) ? v : fallback;
  }

  function getBaseTimesMinutes(){
    // base times for M egg (your defaults)
    const t1 = Math.max(0, n(elT1.value, 4.0));
    const t2 = Math.max(t1, n(elT2.value, 5.0));
    const t3 = Math.max(t2, n(elT3.value, 6.5));
    const t4 = Math.max(t3, n(elT4.value, 8.5));
    const t5 = Math.max(t4, n(elT5.value, 10.5));
    return [t1, t2, t3, t4, t5];
  }

  function getScaledThresholds(){
    const size = elSize.value;
    let weight = n(elWeight.value, 58);
    if (size !== "custom" && SIZE_TO_WEIGHT[size]) {
      weight = SIZE_TO_WEIGHT[size];
    }
    // keep input in sync if user chose preset
    elWeight.value = weight;

    const eggTempC = n(elEggTemp.value, 4);
    const diameterMm = elDiameter.value.trim() === "" ? NaN : n(elDiameter.value, NaN);
    const method = elMethod.value;

    const base = getBaseTimesMinutes();
    const scaled = scaleTimes(base, { weightG: weight, eggTempC, diameterMm, method });

    return { thresholds: scaled, weight, eggTempC, diameterMm, method, base };
  }

  // ---------------------------
  // 5) Build chart data: show "bands" as stepwise ranges
  //    We'll draw stacked filled areas on a 0/1 axis (category bands),
  //    and use annotation-like vertical line via a dataset with two points.
  // ---------------------------
  const ctx = document.getElementById('chart');

  // We'll use minutes as x, and a constant y=1 for fill; bands are separate datasets with (start,end)
  function bandDataset(label, xStart, xEnd){
    return {
      label,
      data: [
        {x: xStart, y: 1},
        {x: xEnd,   y: 1},
      ],
      parsing: false,
      borderWidth: 0,
      pointRadius: 0,
      fill: true
    };
  }

  // vertical line dataset (stopwatch)
  function lineDataset(label, xVal){
    return {
      label,
      data: [
        {x: xVal, y: 0},
        {x: xVal, y: 1.05},
      ],
      parsing: false,
      borderWidth: 2,
      pointRadius: 0,
      fill: false
    };
  }

  // Create chart with placeholder
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: []
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: (items) => {
              const x = items?.[0]?.parsed?.x ?? 0;
              return `Zeit: ${formatMin(x)}`;
            },
            label: (item) => item.dataset.label
          }
        }
      },
      scales: {
        x: {
          type: 'linear',
          title: { display: true, text: 'Zeit' },
          ticks: {
            callback: (v) => formatMin(v)
          },
          min: 0
        },
        y: {
          min: 0,
          max: 1.05,
          display: false
        }
      },
      elements: { line: { tension: 0 } }
    }
  });

  function formatMin(min){
    const totalSec = Math.max(0, min * 60);
    const m = Math.floor(totalSec / 60);
    const s = Math.floor(totalSec % 60);
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  function stageAtTime(min, thresholds){
    // thresholds correspond to: verysoft, soft, waxy, medium, hard (as "reach time")
    const [a,b,c,d,e] = thresholds;
    if (min < a) return "Noch nicht (zu roh)";
    if (min < b) return "Sehr weich";
    if (min < c) return "Weich / Fr√ºhst√ºcksei";
    if (min < d) return "Wachsweich / Kernweich";
    if (min < e) return "Fest / Halbhart";
    return "Hart";
  }

  function updateChart(stopwatchMin = null){
    const { thresholds, weight, eggTempC, diameterMm, method } = getScaledThresholds();
    elEggTempVal.textContent = eggTempC;

    const [t1,t2,t3,t4,t5] = thresholds;
    const maxX = Math.max(12, t5 * 1.15);

    elHeadline.textContent =
      `F√ºr dein Ei (${weight.toFixed(1)} g${Number.isFinite(diameterMm)?`, √ò ${diameterMm.toFixed(1)} mm`:''}, Start ${eggTempC}¬∞C): Zeitfenster je Konsistenz`;

    // Build bands:
    // We fill the whole band area; to differentiate, we rely on dataset order.
    // Chart.js auto-colors; you can adjust later if you want.
    const bands = [
      bandDataset("Sehr weich: Eiwei√ü fest, Eigelb komplett fl√ºssig", t1, t2),
      bandDataset("Weich/Fr√ºhst√ºcksei: Eigelb fl√ºssig-cremig", t2, t3),
      bandDataset("Wachsweich/Kernweich: Rand fest, Mitte fl√ºssig/z√§h", t3, t4),
      bandDataset("Fest/Halbhart: Eigelb weitgehend gestockt", t4, t5),
      bandDataset("Hart: Eigelb komplett fest", t5, maxX)
    ];

    // We'll set background colors explicitly? You didn't ask, so we keep defaults,
    // but we do make bands semi-transparent using scriptable option.
    bands.forEach((ds, idx) => {
      ds.backgroundColor = (ctx) => {
        // subtle different alphas
        const alpha = 0.10 + idx * 0.04;
        return `rgba(77,163,255,${Math.min(0.35, alpha)})`;
      };
    });

    const datasets = [...bands];

    // add stopwatch line
    if (Number.isFinite(stopwatchMin)) {
      const line = lineDataset("Aktuelle Stoppuhr-Zeit", stopwatchMin);
      line.borderColor = "rgba(255,92,122,0.95)";
      datasets.push(line);
      elStageNow.textContent = stageAtTime(stopwatchMin, thresholds);
    } else {
      elStageNow.textContent = "‚Äî";
    }

    chart.data.datasets = datasets;
    chart.options.scales.x.min = 0;
    chart.options.scales.x.max = maxX;
    chart.update();
  }

  // ---------------------------
  // 6) Stopwatch (live line)
  // ---------------------------
  let running = false;
  let startTs = 0;
  let elapsedMs = 0;
  let rafId = null;

  function renderStopwatch(){
    const ms = elapsedMs + (running ? (performance.now() - startTs) : 0);
    const totalSec = ms / 1000;
    const m = Math.floor(totalSec / 60);
    const s = Math.floor(totalSec % 60);
    const tenths = Math.floor((totalSec - Math.floor(totalSec)) * 10);
    elSw.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${tenths}`;
    const min = totalSec / 60;
    updateChart(min);
    rafId = requestAnimationFrame(renderStopwatch);
  }

  function start(){
    if (running) return;
    running = true;
    startTs = performance.now();
    btnStart.disabled = true;
    btnPause.disabled = false;
    rafId = requestAnimationFrame(renderStopwatch);
  }

  function pause(){
    if (!running) return;
    running = false;
    elapsedMs += performance.now() - startTs;
    btnStart.disabled = false;
    btnPause.disabled = true;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    // keep last line shown
    const min = (elapsedMs / 1000) / 60;
    updateChart(min);
  }

  function reset(){
    running = false;
    elapsedMs = 0;
    btnStart.disabled = false;
    btnPause.disabled = true;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    elSw.textContent = "00:00.0";
    updateChart(null);
  }

  btnStart.addEventListener('click', start);
  btnPause.addEventListener('click', pause);
  btnReset.addEventListener('click', reset);

  // ---------------------------
  // 7) Live updates on input changes
  // ---------------------------
  function onInputsChanged(){
    // if stopwatch is running, chart will be updated by RAF anyway; but update the model now
    if (!running) updateChart(null);
  }

  [elSize, elWeight, elDiameter, elEggTemp, elMethod, elT1, elT2, elT3, elT4, elT5].forEach(el => {
    el.addEventListener('input', onInputsChanged);
    el.addEventListener('change', onInputsChanged);
  });

  // apply preset selection -> update weight field
  elSize.addEventListener('change', () => {
    const v = elSize.value;
    if (v !== "custom" && SIZE_TO_WEIGHT[v]) elWeight.value = SIZE_TO_WEIGHT[v];
    onInputsChanged();
  });

  // init
  updateChart(null);
</script>
</body>
</html>
